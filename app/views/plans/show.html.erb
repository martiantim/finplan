Hello <%= @current_user.name %>

<div class="clearit">
  <div id="chart"></div>
  <div id="chart_controls">
    <div id="xtype" data-value="year">
      <a href="#" data-xtype="year">year</a>/<a href="#" data-xtype="age">age</a>
    </div>
  </div>
</div>

<div id="details" style="display:none;"></div>
<h2>Factors</h2>
<% @plan.manipulators.each do |m|  %>
  <div class="manipulator" data-id="<%=m.id%>">
    <a href="#" class="edit"><%= m.name %></a>
    <%= link_to 'x', '#', :class => 'remove' %>
  </div>
<% end %>

<% @plan.unused_templates.each do |t| %>
  <a href="#" class="add_manipulator" data-template-id="<%=t.id%>">Add <%= t.name %></a>  
<% end %>
<div id="manipulator_dialog" title="New Manipulator">  
</div>

<%= javascript_tag do %>
  $(function() {
    plan = new Plan('<%=@plan.name%>');
    <% @plan.manipulators.each do |m| %>
      var m = Manipulator.fromJSON(<%= raw m.safe_json.to_json %>);      
      plan.add(m);
    <% end %>
    plan.display();
    
    $('.manipulator .edit').click(function() {    
      var d = $( "#manipulator_dialog" ).dialog({
        height: 250,
        modal: true        
      });
      $.ajax({
        url: '/manipulators/'+$(this).closest('.manipulator').attr('data-id'),
        type: 'GET',
        dataType: 'html',        
        success: function(data) {
          d.html(data);
        }          
      });
    
      return false;
    });
    
    $('.manipulator .remove').click(function() {    
      var div = $(this).closest('.manipulator');
      $.ajax({
        url: '/manipulators/'+div.attr('data-id'),
        type: 'POST',
        data: {'_method' : 'delete'},
        success: function(data) {
          div.remove();
        }          
      });
    });
    
    $('.add_manipulator').click(function() {    
      var d = $( "#manipulator_dialog" ).dialog({
        height: 250,
        modal: true        
      });
      $.ajax({
        url: '/manipulators/new',
        type: 'GET',
        dataType: 'html',
        data: {
          plan_id: <%= @plan.id %>,
          manipulator_template_id: $(this).attr('data-template-id')
        },
        success: function(data) {
          d.html(data);
        }          
      });      
      return false;
    });
  });
<% end %>